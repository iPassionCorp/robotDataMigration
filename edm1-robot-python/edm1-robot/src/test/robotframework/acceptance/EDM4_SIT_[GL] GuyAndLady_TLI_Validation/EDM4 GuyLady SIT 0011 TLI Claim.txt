*** Settings ***
Library           DatabaseLibrary
Resource          ../../keywords/edm.txt
Resource          ../../Repositories/${env}/${dbname}_${env}_Connection.txt

*** Test Cases ***
EDM4_GuyLady_SIT_TLI_Claim_0011_0001_Recconcile
    [Documentation]    Recconcile Table Claim ระหว่าง Taget และ Source
    EDM_Connect_DB
    @{Result}    Query    select count (*) from ( select count(*) from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode except all select count(*) from ( select a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno ) source ) tmp;
    EDM_Compare Result    @{Result[0]}    0    Table Claim

EDM4_GuyLady_SIT_TLI_Claim_0011_0002_PK
    [Documentation]    ตรวจสอบข้อมูล PK ของ Table Claim
    EDM_Connect_DB
    @{Result}    Query    select count(*) from ( SELECT a.claimtype, a.msttype, a.policyno, a.receiveyyyymm, a.sectioncode, a.orderno ,count(*) FROM dm.claim a \ \ \ join dm.tlpmigration b on a.policyno = b.migrateplancode GROUP BY a.claimtype, a.msttype, a.policyno, a.receiveyyyymm, a.sectioncode, a.orderno \ \ \ \ \ HAVING \ count (*) > 1 ) as t
    EDM_Compare Result    @{Result[0]}    0    Table Claim

EDM4_GuyLady_SIT_TLI_Claim_0011_0003_claimType_Mapping
    [Documentation]    Except Source กับ Target
    EDM_Connect_DB
    @{Result}    Query    select count (0) from (select \ c.migrateplancode as policy, CASE WHEN a.RegDtlDateOfDeath = '00000000' OR a.RegDtlDateOfDeath = '' THEN 'A' WHEN a.RegDtlDateOfDeath <> '00000000' AND a.RegDtlDateOfDeath <> '' AND length(a.RegDtlDateOfDeath) = 8 \ and a.RegDtlDateOfDeath !~* '[a-zก-ฮ]' THEN 'D' ELSE 'error' end as claimtype from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtldateofdeath except all select a.policyno as policy, a.claimtype from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode) tmp; select count (0) from (select a.policyno as policy, a.claimtype from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode \ except all select \ c.migrateplancode as policy, CASE WHEN a.RegDtlDateOfDeath = '00000000' OR a.RegDtlDateOfDeath = '' THEN 'A' WHEN a.RegDtlDateOfDeath <> '00000000' AND a.RegDtlDateOfDeath <> '' AND length(a.RegDtlDateOfDeath) = 8 \ and a.RegDtlDateOfDeath !~* '[a-zก-ฮ]' THEN 'D' ELSE 'error' end as claimtype from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtldateofdeath) \ tmp;
    EDM_Compare Result    @{Result[0]}    0    claimType

EDM4_GuyLady_SIT_TLI_Claim_0011_0004_mstType_Default
    EDM_Connect_DB
    @{Result}    Query    SELECT count (*) \ FROM dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode WHERE msttype <> 'O';
    EDM_Compare Result    @{Result[0]}    0    mstType

EDM4_GuyLady_SIT_TLI_Claim_0011_0005_policyNo_Direct Move
    EDM_Connect_DB
    @{Result}    Query    SELECT count (*) FROM dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode WHERE a.policyno <> b.migrateplancode;
    EDM_Compare Result    @{Result[0]}    0    policyNo

EDM4_GuyLady_SIT_TLI_Claim_0011_0006_receiveyyyymm_Mapping
    [Documentation]    Except Source กับ Target
    EDM_Connect_DB
    @{Result}    Query    select count (0) \ from ( select c.migrateplancode as policy, CASE WHEN a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '' then '201806' when length(a.regdtlregisterdate) = 8 and a.regdtlregisterdate !~* '[a-zก-ฮ]' then substring(a.regdtlregisterdate,1,6) \ end as receiveyyyymm \ \ \ \ \ \ \ \ \ from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode except all \ \ select a.policyno as policy, a.receiveyyyymm from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode) tmp; select count (0) \ from (select a.policyno as policy, a.receiveyyyymm from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode except all select c.migrateplancode as policy, CASE WHEN a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '' then '201806' when length(a.regdtlregisterdate) = 8 and a.regdtlregisterdate !~* '[a-zก-ฮ]' then substring(a.regdtlregisterdate,1,6) \ end as receiveyyyymm \ \ \ \ \ \ \ \ \ from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode) \ tmp;
    EDM_Compare Result    @{Result[0]}    0    receiveyyyymm

EDM4_GuyLady_SIT_TLI_Claim_0011_0007_sectionCode_Default
    EDM_Connect_DB
    @{Result}    Query    SELECT count (0) FROM dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode WHERE a.sectioncode <> '95';
    EDM_Compare Result    @{Result[0]}    0    sectionCode

EDM4_GuyLady_SIT_TLI_Claim_0011_0008_orderNo_Mapping
    EDM_Connect_DB
    @{Result}    Query    select count (0) \ \ from (select c.migrateplancode as policy, a.regdtlclaimno as orderno from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtlclaimno except all select a.policyno as policy, a.orderno as orderno \ from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode) tmp; select count (0) \ \ from (select a.policyno as policy, a.orderno as orderno \ from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode \ except all select c.migrateplancode as policy, a.regdtlclaimno as orderno from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtlclaimno) tmp;
    EDM_Compare Result    @{Result[0]}    0    orderNo

EDM4_GuyLady_SIT_TLI_Claim_0011_0009_referenceNo_Generate
    EDM_Connect_DB
    @{Result}    Query    select count (0) from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode \ where a.referenceno = '';
    EDM_Compare Result    @{Result[0]}    0    referenceNo

EDM4_GuyLady_SIT_TLI_Claim_0011_0010_okDate_Mapping
    EDM_Connect_DB
    @{Result}    Query    select count (0) \ \ from (select c.migrateplancode as policy, a.regdtlapprovedate as okdate from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtlclaimno,a.regdtlapprovedate except all \ \ select a.policyno as policy, a.okdate as okdate from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode) tmp; \ select count (0) from (select a.policyno as policy, a.okdate as okdate from dm.claim a join dm.tlpmigration b on a.policyno = b.migrateplancode \ except all select c.migrateplancode as policy, a.regdtlapprovedate as okdate from tlp.claimregisterdetail a join tlp.claimregisterheader b on a. registerseq = b.registerseq join dm.tlpmigration c on b.regcustomercode = c.customercode and b.regcustomercertificateno = c.tlpcertno where \ ((a.regdtldateofdeath = '00000000' and a.regdtldateofdeath <> '') or (length(a.regdtldateofdeath) = 8 and a.regdtldateofdeath !~* '[a-zก-ฮ]')) \ \ \ and ((a.regdtlregisterdate = '00000000' or a.regdtlregisterdate = '') or (length(a.regdtlregisterdate) = 8 \ and a.regdtlregisterdate !~* '[a-zก-ฮ]')) and ((a.regdtlapprovedate = '00000000' and a.regdtlapprovedate <> '') or (length(a.regdtlapprovedate) = 8 and a.regdtlapprovedate !~* '[a-zก-ฮ]')) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ group by a.regdtlregisterdate, a.registerseq, b.regcustomercode, b.regcustomercertificateno,c.migrateplancode,a.regdtlclaimno,a.regdtlapprovedate) tmp;
    EDM_Compare Result    @{Result[0]}    0    okDate
